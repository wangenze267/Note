# OCR 重构分析
## 一、原型及需求分析
### 1、原型分析及拆解
<img src="https://img.wangez.site/img/ocr%E5%8E%9F%E5%9E%8B%E6%A6%82%E5%BF%B5%E5%9B%BE.jpg" width="600px">

页面主题区域大约分为四部分，分别为 **原图** 区域、解析出来的 OCR 文本区域、**批注** 区域、以及根据批注生成在 OCR 文本 **对应行高** 位置的 **icon** 区域。

根据交互，其中原图与 OCR 区域的可视效果可随交互的变化进行 **显示** 和 **隐藏**。

且，原图与 OCR 内容包含 **缩放交互**。
### 2、需求拆解及分析
需求如下：
- 在 OCR 文本区域进行鼠标滑动批注，添加批注后，高亮鼠标选中的 OCR 区域，对应批注应在右侧批注区域显示出来。
- 点击批注可触发连线，连接到对应批注的 OCR 区域和对应的原图区域（高亮显示）
- 文件有多个，当点击的批注不是当前文件时，要跳转到被点击的批注对应的文件
- 批注后，触发连线的方式共有 **三种**：点击右侧批注的文件标签（即上文所说的点击批注），点击高亮的 OCR 区域，点击 OCR 区域对应生成的 icon

分析如下：
- 一条批注意见可以对应 OCR 上的多个批注位置，一条批注可以拥有不同位置的多个 icon，近而可对应原图中的多个位置
- 一个icon 只对应 一条 OCR 上的批注，**注意：icon 存在堆叠情况，此时 icon 可能对应多个批注**
- 要尽量保持连线逻辑单一，方便后续维护

<img src="https://img.wangez.site/img/%E8%BF%9E%E7%BA%BF%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1.jpg" width="600px">

新增需求如下：
- PDF 文件，按页码拆分成多个图片，但是批注仍按一个 PDF 文件处理

分析如下：
- 在现有的文件数据结构下，针对 **非图片的情况进行处理** （目前仅为 PDF）
- 每个文件种类应有特殊字段标识，接口新增 type 字段
- PDF 与其拆分成的图片的结构关系，按 children 进行处理 (Tree)
## 二、现有代码分析
### 现有连线逻辑分析
现有的连线逻辑为，点击 OCR 区域内的关键词，触发连线至两侧的原图以及批注区域。
> 介于 OCR 可以被隐藏的交互，加上需求明显是以意见为主体进行关系设计，选择放弃此路，连线的出发点不应在中间。

<img src="https://img.wangez.site/img/%E8%BF%9E%E7%BA%BF%E5%8F%82%E7%85%A7.jpg" width="600px">

现有的左侧原图区域的视觉交互高亮，与新需求相同，可以复用。
> 但是原先的连线逻辑为 一对一对一，现在明显会存在 一对多，所以要进行改造

原先代码：
```html
<!--原先的高亮 Dom-->
<div>
    <Dom :style="传进来的位置信息，利用此信息使得Dom定位至原图对应位置">
</div>

<!--原先的传入对象:
    lineWordItem:{
        location: {
            top,left,width,height
        },
        word: 关键词信息,
        ...Other
    }
-->
```

改造后代码：
```html
<!--改造后的高亮 Dom-->
<div v-for>
    <Dom  :style="传进来的位置信息，利用此信息使得Dom定位至原图对应位置">
</div>

<!--改造后的传入对象:
    lineWordItem:[
        {
            location: {
                top,left,width,height
            },
            word: 关键词信息,
            ...Other
        }
        ...Others
    ]
-->
```
### 3、现有数据内容对应关系分析

意见区域数据：
```js
comments: [
    files: [],
    str: '',
    words: [],
    selectText: '',
    ...
]
```

OCR 区域：
```js
ocr: [
    [
        'str'
    ],
    [
        {word}
    ],
    [
        'str',
        {word}
    ]
]
```

借助 自定义属性 `data-xxx`，利用时间戳当作唯一值，将两个区域连接起来。

即，鼠标选中时，给予被选中元素一个时间戳，然后将时间戳传递到批注意见的数据中存储起来，以此将两个区域关联起来。

icon 关系梳理同理，上文中的自定义属性，可以通过点击事件拿到，所以我们在 icon 的数据存储设计中，也应将这个时间戳考虑进去，以此关联这两个区域。

且，通过这个时间戳，icon 与批注意见也能关联起来。

具体数据结构设计见第四节。

## 三、待补充代码分析
### 多对多关系分析
### 连线方案分析
### 三屏、双屏切换时位置缩放计算
## 四、数据结构设计
### 批注数据结构设计
### OCR 数据结构设计
### icon 数据结构设计
## 五、细节功能设计
### icon 定位方案
### 批注连线设计方案